
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @first_settlement_session_19 INT
DECLARE @first_settlement_session_89 INT


while (@first_settlement_session_19 IS NULL AND @first_settlement_session_89 IS NULL) BEGIN
select  TOP 1 @first_settlement_session_19 =  session_id from [172.75.75.19].postilion_office.dbo.sstl_session(NOLOCK) Where completed = 1 AND  CONVERT(DATE, datetime_started) = convert(date, GETDATE()) order by  session_id

select  TOP 1 @first_settlement_session_89 =  session_id from [172.25.10.89].postilion_office.dbo.sstl_session(NOLOCK) Where completed = 1 AND  CONVERT(DATE, datetime_started) = convert(date, GETDATE()) order by  session_id

WAITFOR DELAY '00:02:00'
END

IF (@first_settlement_session_19 IS NULL AND @first_settlement_session_89 IS NOT NULL) BEGIN
 PRINT 'Fetching data from 89';
 
 SELECT * FROM  OPENQUERY( [172.25.10.89], 
 'SELECT PT.[post_tran_id]	PT_post_tran_id	,PT.[post_tran_cust_id]	PT_post_tran_cust_id	,PT.[settle_entity_id]	PT_settle_entity_id	,PT.[batch_nr]	PT_batch_nr	,PT.[prev_post_tran_id]	PT_prev_post_tran_id	,PT.[next_post_tran_id]	PT_next_post_tran_id	,PT.[sink_node_name]	PT_sink_node_name	,PT.[tran_postilion_originated]	PT_tran_postilion_originated	,PT.[tran_completed]	PT_tran_completed	,PT.[message_type]	PT_message_type	,PT.[tran_type]	PT_tran_type	,PT.[tran_nr]	PT_tran_nr	,PT.[system_trace_audit_nr]	PT_system_trace_audit_nr	,PT.[rsp_code_req]	PT_rsp_code_req	,PT.[rsp_code_rsp]	PT_rsp_code_rsp	,PT.[abort_rsp_code]	PT_abort_rsp_code	,PT.[auth_id_rsp]	PT_auth_id_rsp	,PT.[auth_type]	PT_auth_type	,PT.[auth_reason]	PT_auth_reason	,PT.[retention_data]	PT_retention_data	,PT.[acquiring_inst_id_code]	PT_acquiring_inst_id_code	,PT.[message_reason_code]	PT_message_reason_code	,PT.[sponsor_bank]	PT_sponsor_bank	,PT.[retrieval_reference_nr]	PT_retrieval_reference_nr	,PT.[datetime_tran_gmt]	PT_datetime_tran_gmt	,PT.[datetime_tran_local]	PT_datetime_tran_local	,PT.[datetime_req]	PT_datetime_req	,PT.[datetime_rsp]	PT_datetime_rsp	,PT.[realtime_business_date]	PT_realtime_business_date	,PT.[recon_business_date]	PT_recon_business_date	,PT.[from_account_type]	PT_from_account_type	,PT.[to_account_type]	PT_to_account_type	,PT.[from_account_id]	PT_from_account_id	,PT.[to_account_id]	PT_to_account_id	,PT.[tran_amount_req]	PT_tran_amount_req	,PT.[tran_amount_rsp]	PT_tran_amount_rsp	,PT.[settle_amount_impact]	PT_settle_amount_impact	,PT.[tran_cash_req]	PT_tran_cash_req	,PT.[tran_cash_rsp]	PT_tran_cash_rsp	,PT.[tran_currency_code]	PT_tran_currency_code	,PT.[tran_tran_fee_req]	PT_tran_tran_fee_req	,PT.[tran_tran_fee_rsp]	PT_tran_tran_fee_rsp	,PT.[tran_tran_fee_currency_code]	PT_tran_tran_fee_currency_code	,PT.[tran_proc_fee_req]	PT_tran_proc_fee_req	,PT.[tran_proc_fee_rsp]	PT_tran_proc_fee_rsp	,PT.[tran_proc_fee_currency_code]	PT_tran_proc_fee_currency_code	,PT.[settle_amount_req]	PT_settle_amount_req	,PT.[settle_amount_rsp]	PT_settle_amount_rsp	,PT.[settle_cash_req]	PT_settle_cash_req	,PT.[settle_cash_rsp]	PT_settle_cash_rsp	,PT.[settle_tran_fee_req]	PT_settle_tran_fee_req	,PT.[settle_tran_fee_rsp]	PT_settle_tran_fee_rsp	,PT.[settle_proc_fee_req]	PT_settle_proc_fee_req	,PT.[settle_proc_fee_rsp]	PT_settle_proc_fee_rsp	,PT.[settle_currency_code]	PT_settle_currency_code	,PT.[pos_entry_mode]	PT_pos_entry_mode	,PT.[pos_condition_code]	PT_pos_condition_code	,PT.[additional_rsp_data]	PT_additional_rsp_data	,PT.[tran_reversed]	PT_tran_reversed	,PT.[prev_tran_approved]	PT_prev_tran_approved	,PT.[issuer_network_id]	PT_issuer_network_id	,PT.[acquirer_network_id]	PT_acquirer_network_id	,PT.[extended_tran_type]	PT_extended_tran_type	,PT.[from_account_type_qualifier]	PT_from_account_type_qualifier	,PT.[to_account_type_qualifier]	PT_to_account_type_qualifier	,PT.[bank_details]	PT_bank_details	,PT.[payee]	PT_payee	,PT.[card_verification_result]	PT_card_verification_result	,PT.[online_system_id]	PT_online_system_id	,PT.[participant_id]	PT_participant_id	,PT.[opp_participant_id]	PT_opp_participant_id	,PT.[receiving_inst_id_code]	PT_receiving_inst_id_code	,PT.[routing_type]	PT_routing_type	,PT.[pt_pos_operating_environment]	PT_pt_pos_operating_environment	,PT.[pt_pos_card_input_mode]	PT_pt_pos_card_input_mode	,PT.[pt_pos_cardholder_auth_method]	PT_pt_pos_cardholder_auth_method	,PT.[pt_pos_pin_capture_ability]	PT_pt_pos_pin_capture_ability	,PT.[pt_pos_terminal_operator]	PT_pt_pos_terminal_operator	,PT.[source_node_key]	PT_source_node_key	,PT.[proc_online_system_id]	PT_proc_online_system_id	,PTC.[post_tran_cust_id]	PTC_post_tran_cust_id	,PTC.[source_node_name]	PTC_source_node_name	,PTC.[draft_capture]	PTC_draft_capture	,PTC.[pan]	PTC_pan	,PTC.[card_seq_nr]	PTC_card_seq_nr	,PTC.[expiry_date]	PTC_expiry_date	,PTC.[service_restriction_code]	PTC_service_restriction_code	,PTC.[terminal_id]	PTC_terminal_id	,PTC.[terminal_owner]	PTC_terminal_owner	,PTC.[card_acceptor_id_code]	PTC_card_acceptor_id_code	,PTC.[mapped_card_acceptor_id_code]	PTC_mapped_card_acceptor_id_code	,PTC.[merchant_type]	PTC_merchant_type	,PTC.[card_acceptor_name_loc]	PTC_card_acceptor_name_loc	,PTC.[address_verification_data]	PTC_address_verification_data	,PTC.[address_verification_result]	PTC_address_verification_result	,PTC.[check_data]	PTC_check_data	,PTC.[totals_group]	PTC_totals_group	,PTC.[card_product]	PTC_card_product	,PTC.[pos_card_data_input_ability]	PTC_pos_card_data_input_ability	,PTC.[pos_cardholder_auth_ability]	PTC_pos_cardholder_auth_ability	,PTC.[pos_card_capture_ability]	PTC_pos_card_capture_ability	,PTC.[pos_operating_environment]	PTC_pos_operating_environment	,PTC.[pos_cardholder_present]	PTC_pos_cardholder_present	,PTC.[pos_card_present]	PTC_pos_card_present	,PTC.[pos_card_data_input_mode]	PTC_pos_card_data_input_mode	,PTC.[pos_cardholder_auth_method]	PTC_pos_cardholder_auth_method	,PTC.[pos_cardholder_auth_entity]	PTC_pos_cardholder_auth_entity	,PTC.[pos_card_data_output_ability]	PTC_pos_card_data_output_ability	,PTC.[pos_terminal_output_ability]	PTC_pos_terminal_output_ability	,PTC.[pos_pin_capture_ability]	PTC_pos_pin_capture_ability	,PTC.[pos_terminal_operator]	PTC_pos_terminal_operator	,PTC.[pos_terminal_type]	PTC_pos_terminal_type	,PTC.[pan_search]	PTC_pan_search	,PTC.[pan_encrypted]	PTC_pan_encrypted	,PTC.[pan_reference]	PTC_pan_reference
 FROM  (select * from  postilion_office.dbo.post_tran AS t  WITH (NOLOCK, index(IX_POST_TRAN_9))
 JOIN (SELECT  [DATE] recon_business_date_2 FROM  postilion_office.dbo.[get_dates_in_range](''SETTLE_START_DATE'', ''SETTLE_END_DATE'' ))rdate
 ON (rdate.recon_business_date_2 = t.recon_business_date)
 AND post_tran_id NOT IN (
 					SELECT  post_tran_id  FROM postilion_office.dbo.tbl_late_reversals ll (NOLOCK) 
 		WHERE ll.recon_business_date >= ''SETTLE_START_DATE''
 		and (datepart(D,ll.rev_datetime_req) - datepart(D, ll.trans_datetime_req ))>1 
 					) AND
 					rsp_code_rsp IN (''00'',''11'',''09''))PT
  LEFT JOIN  postilion_office.dbo.Post_tran_cust AS PTC WITH  (NOLOCK)
 ON (PT.post_tran_cust_id = PTC.post_tran_cust_id
  AND  LEFT( source_node_name,2 ) <> ''SB''
 AND  CHARINDEX(''TPP'',source_node_name )<1
 AND source_node_name <> ''SWTMEGADSsrc'' )
 AND LEFT(card_acceptor_id_code,3) <>''IPG''
 WHERE
  LEFT(sink_node_name,2)<> ''SB''
 				 and  sink_node_name <> ''WUESBPBsnk''
 	   and CHARINDEX(''TPP'', sink_node_name) < 1 OPTION(RECOMPILE,optimize for unknown ) ')



END
ELSE IF (@first_settlement_session_19 IS NOT NULL AND @first_settlement_session_89 IS NULL) BEGIN
 SELECT * FROM  OPENQUERY( [172.75.75.19], 
'SELECT PT.[post_tran_id]	PT_post_tran_id	,PT.[post_tran_cust_id]	PT_post_tran_cust_id	,PT.[settle_entity_id]	PT_settle_entity_id	,PT.[batch_nr]	PT_batch_nr	,PT.[prev_post_tran_id]	PT_prev_post_tran_id	,PT.[next_post_tran_id]	PT_next_post_tran_id	,PT.[sink_node_name]	PT_sink_node_name	,PT.[tran_postilion_originated]	PT_tran_postilion_originated	,PT.[tran_completed]	PT_tran_completed	,PT.[message_type]	PT_message_type	,PT.[tran_type]	PT_tran_type	,PT.[tran_nr]	PT_tran_nr	,PT.[system_trace_audit_nr]	PT_system_trace_audit_nr	,PT.[rsp_code_req]	PT_rsp_code_req	,PT.[rsp_code_rsp]	PT_rsp_code_rsp	,PT.[abort_rsp_code]	PT_abort_rsp_code	,PT.[auth_id_rsp]	PT_auth_id_rsp	,PT.[auth_type]	PT_auth_type	,PT.[auth_reason]	PT_auth_reason	,PT.[retention_data]	PT_retention_data	,PT.[acquiring_inst_id_code]	PT_acquiring_inst_id_code	,PT.[message_reason_code]	PT_message_reason_code	,PT.[sponsor_bank]	PT_sponsor_bank	,PT.[retrieval_reference_nr]	PT_retrieval_reference_nr	,PT.[datetime_tran_gmt]	PT_datetime_tran_gmt	,PT.[datetime_tran_local]	PT_datetime_tran_local	,PT.[datetime_req]	PT_datetime_req	,PT.[datetime_rsp]	PT_datetime_rsp	,PT.[realtime_business_date]	PT_realtime_business_date	,PT.[recon_business_date]	PT_recon_business_date	,PT.[from_account_type]	PT_from_account_type	,PT.[to_account_type]	PT_to_account_type	,PT.[from_account_id]	PT_from_account_id	,PT.[to_account_id]	PT_to_account_id	,PT.[tran_amount_req]	PT_tran_amount_req	,PT.[tran_amount_rsp]	PT_tran_amount_rsp	,PT.[settle_amount_impact]	PT_settle_amount_impact	,PT.[tran_cash_req]	PT_tran_cash_req	,PT.[tran_cash_rsp]	PT_tran_cash_rsp	,PT.[tran_currency_code]	PT_tran_currency_code	,PT.[tran_tran_fee_req]	PT_tran_tran_fee_req	,PT.[tran_tran_fee_rsp]	PT_tran_tran_fee_rsp	,PT.[tran_tran_fee_currency_code]	PT_tran_tran_fee_currency_code	,PT.[tran_proc_fee_req]	PT_tran_proc_fee_req	,PT.[tran_proc_fee_rsp]	PT_tran_proc_fee_rsp	,PT.[tran_proc_fee_currency_code]	PT_tran_proc_fee_currency_code	,PT.[settle_amount_req]	PT_settle_amount_req	,PT.[settle_amount_rsp]	PT_settle_amount_rsp	,PT.[settle_cash_req]	PT_settle_cash_req	,PT.[settle_cash_rsp]	PT_settle_cash_rsp	,PT.[settle_tran_fee_req]	PT_settle_tran_fee_req	,PT.[settle_tran_fee_rsp]	PT_settle_tran_fee_rsp	,PT.[settle_proc_fee_req]	PT_settle_proc_fee_req	,PT.[settle_proc_fee_rsp]	PT_settle_proc_fee_rsp	,PT.[settle_currency_code]	PT_settle_currency_code	,PT.[pos_entry_mode]	PT_pos_entry_mode	,PT.[pos_condition_code]	PT_pos_condition_code	,PT.[additional_rsp_data]	PT_additional_rsp_data	,PT.[tran_reversed]	PT_tran_reversed	,PT.[prev_tran_approved]	PT_prev_tran_approved	,PT.[issuer_network_id]	PT_issuer_network_id	,PT.[acquirer_network_id]	PT_acquirer_network_id	,PT.[extended_tran_type]	PT_extended_tran_type	,PT.[from_account_type_qualifier]	PT_from_account_type_qualifier	,PT.[to_account_type_qualifier]	PT_to_account_type_qualifier	,PT.[bank_details]	PT_bank_details	,PT.[payee]	PT_payee	,PT.[card_verification_result]	PT_card_verification_result	,PT.[online_system_id]	PT_online_system_id	,PT.[participant_id]	PT_participant_id	,PT.[opp_participant_id]	PT_opp_participant_id	,PT.[receiving_inst_id_code]	PT_receiving_inst_id_code	,PT.[routing_type]	PT_routing_type	,PT.[pt_pos_operating_environment]	PT_pt_pos_operating_environment	,PT.[pt_pos_card_input_mode]	PT_pt_pos_card_input_mode	,PT.[pt_pos_cardholder_auth_method]	PT_pt_pos_cardholder_auth_method	,PT.[pt_pos_pin_capture_ability]	PT_pt_pos_pin_capture_ability	,PT.[pt_pos_terminal_operator]	PT_pt_pos_terminal_operator	,PT.[source_node_key]	PT_source_node_key	,PT.[proc_online_system_id]	PT_proc_online_system_id	,PTC.[post_tran_cust_id]	PTC_post_tran_cust_id	,PTC.[source_node_name]	PTC_source_node_name	,PTC.[draft_capture]	PTC_draft_capture	,PTC.[pan]	PTC_pan	,PTC.[card_seq_nr]	PTC_card_seq_nr	,PTC.[expiry_date]	PTC_expiry_date	,PTC.[service_restriction_code]	PTC_service_restriction_code	,PTC.[terminal_id]	PTC_terminal_id	,PTC.[terminal_owner]	PTC_terminal_owner	,PTC.[card_acceptor_id_code]	PTC_card_acceptor_id_code	,PTC.[mapped_card_acceptor_id_code]	PTC_mapped_card_acceptor_id_code	,PTC.[merchant_type]	PTC_merchant_type	,PTC.[card_acceptor_name_loc]	PTC_card_acceptor_name_loc	,PTC.[address_verification_data]	PTC_address_verification_data	,PTC.[address_verification_result]	PTC_address_verification_result	,PTC.[check_data]	PTC_check_data	,PTC.[totals_group]	PTC_totals_group	,PTC.[card_product]	PTC_card_product	,PTC.[pos_card_data_input_ability]	PTC_pos_card_data_input_ability	,PTC.[pos_cardholder_auth_ability]	PTC_pos_cardholder_auth_ability	,PTC.[pos_card_capture_ability]	PTC_pos_card_capture_ability	,PTC.[pos_operating_environment]	PTC_pos_operating_environment	,PTC.[pos_cardholder_present]	PTC_pos_cardholder_present	,PTC.[pos_card_present]	PTC_pos_card_present	,PTC.[pos_card_data_input_mode]	PTC_pos_card_data_input_mode	,PTC.[pos_cardholder_auth_method]	PTC_pos_cardholder_auth_method	,PTC.[pos_cardholder_auth_entity]	PTC_pos_cardholder_auth_entity	,PTC.[pos_card_data_output_ability]	PTC_pos_card_data_output_ability	,PTC.[pos_terminal_output_ability]	PTC_pos_terminal_output_ability	,PTC.[pos_pin_capture_ability]	PTC_pos_pin_capture_ability	,PTC.[pos_terminal_operator]	PTC_pos_terminal_operator	,PTC.[pos_terminal_type]	PTC_pos_terminal_type	,PTC.[pan_search]	PTC_pan_search	,PTC.[pan_encrypted]	PTC_pan_encrypted	,PTC.[pan_reference]	PTC_pan_reference
FROM  (select * from  postilion_office.dbo.post_tran AS t  WITH (NOLOCK, index(IX_POST_TRAN_9))
JOIN (SELECT  [DATE] recon_business_date_2 FROM  postilion_office.dbo.[get_dates_in_range](''SETTLE_START_DATE'', ''SETTLE_END_DATE'' ))rdate
ON (rdate.recon_business_date_2 = t.recon_business_date)
AND post_tran_id NOT IN (
					SELECT  post_tran_id  FROM postilion_office.dbo.tbl_late_reversals ll (NOLOCK) 
		WHERE ll.recon_business_date >= ''SETTLE_START_DATE''
		and (datepart(D,ll.rev_datetime_req) - datepart(D, ll.trans_datetime_req ))>1 
					) AND
					rsp_code_rsp IN (''00'',''11'',''09''))PT
 LEFT JOIN  postilion_office.dbo.Post_tran_cust AS PTC WITH  (NOLOCK)
ON (PT.post_tran_cust_id = PTC.post_tran_cust_id
 AND  LEFT( source_node_name,2 ) <> ''SB''
AND  CHARINDEX(''TPP'',source_node_name )<1
AND source_node_name <> ''SWTMEGADSsrc'' )
AND LEFT(card_acceptor_id_code,3) <>''IPG''
WHERE
 LEFT(sink_node_name,2)<> ''SB''
				 and  sink_node_name <> ''WUESBPBsnk''
	   and CHARINDEX(''TPP'', sink_node_name) < 1 OPTION(RECOMPILE,optimize for unknown ) ')



END
ELSE IF (@first_settlement_session_19 IS NOT NULL AND @first_settlement_session_89 IS NOT NULL) BEGIN
DECLARE @server_one_count BIGINT
DECLARE @server_two_count BIGINT

SELECT @server_one_count   = count(*) FROM   [172.25.10.89].[postilion_office].dbo.temp_journal_data  
SELECT @server_two_count = count(*) FROM   [172.75.75.19].[postilion_office].dbo.temp_journal_data	
IF (@server_one_count>=@server_two_count ) BEGIN 

 SELECT * FROM  OPENQUERY( [172.25.10.89], 
'SELECT PT.[post_tran_id]	PT_post_tran_id	,PT.[post_tran_cust_id]	PT_post_tran_cust_id	,PT.[settle_entity_id]	PT_settle_entity_id	,PT.[batch_nr]	PT_batch_nr	,PT.[prev_post_tran_id]	PT_prev_post_tran_id	,PT.[next_post_tran_id]	PT_next_post_tran_id	,PT.[sink_node_name]	PT_sink_node_name	,PT.[tran_postilion_originated]	PT_tran_postilion_originated	,PT.[tran_completed]	PT_tran_completed	,PT.[message_type]	PT_message_type	,PT.[tran_type]	PT_tran_type	,PT.[tran_nr]	PT_tran_nr	,PT.[system_trace_audit_nr]	PT_system_trace_audit_nr	,PT.[rsp_code_req]	PT_rsp_code_req	,PT.[rsp_code_rsp]	PT_rsp_code_rsp	,PT.[abort_rsp_code]	PT_abort_rsp_code	,PT.[auth_id_rsp]	PT_auth_id_rsp	,PT.[auth_type]	PT_auth_type	,PT.[auth_reason]	PT_auth_reason	,PT.[retention_data]	PT_retention_data	,PT.[acquiring_inst_id_code]	PT_acquiring_inst_id_code	,PT.[message_reason_code]	PT_message_reason_code	,PT.[sponsor_bank]	PT_sponsor_bank	,PT.[retrieval_reference_nr]	PT_retrieval_reference_nr	,PT.[datetime_tran_gmt]	PT_datetime_tran_gmt	,PT.[datetime_tran_local]	PT_datetime_tran_local	,PT.[datetime_req]	PT_datetime_req	,PT.[datetime_rsp]	PT_datetime_rsp	,PT.[realtime_business_date]	PT_realtime_business_date	,PT.[recon_business_date]	PT_recon_business_date	,PT.[from_account_type]	PT_from_account_type	,PT.[to_account_type]	PT_to_account_type	,PT.[from_account_id]	PT_from_account_id	,PT.[to_account_id]	PT_to_account_id	,PT.[tran_amount_req]	PT_tran_amount_req	,PT.[tran_amount_rsp]	PT_tran_amount_rsp	,PT.[settle_amount_impact]	PT_settle_amount_impact	,PT.[tran_cash_req]	PT_tran_cash_req	,PT.[tran_cash_rsp]	PT_tran_cash_rsp	,PT.[tran_currency_code]	PT_tran_currency_code	,PT.[tran_tran_fee_req]	PT_tran_tran_fee_req	,PT.[tran_tran_fee_rsp]	PT_tran_tran_fee_rsp	,PT.[tran_tran_fee_currency_code]	PT_tran_tran_fee_currency_code	,PT.[tran_proc_fee_req]	PT_tran_proc_fee_req	,PT.[tran_proc_fee_rsp]	PT_tran_proc_fee_rsp	,PT.[tran_proc_fee_currency_code]	PT_tran_proc_fee_currency_code	,PT.[settle_amount_req]	PT_settle_amount_req	,PT.[settle_amount_rsp]	PT_settle_amount_rsp	,PT.[settle_cash_req]	PT_settle_cash_req	,PT.[settle_cash_rsp]	PT_settle_cash_rsp	,PT.[settle_tran_fee_req]	PT_settle_tran_fee_req	,PT.[settle_tran_fee_rsp]	PT_settle_tran_fee_rsp	,PT.[settle_proc_fee_req]	PT_settle_proc_fee_req	,PT.[settle_proc_fee_rsp]	PT_settle_proc_fee_rsp	,PT.[settle_currency_code]	PT_settle_currency_code	,PT.[pos_entry_mode]	PT_pos_entry_mode	,PT.[pos_condition_code]	PT_pos_condition_code	,PT.[additional_rsp_data]	PT_additional_rsp_data	,PT.[tran_reversed]	PT_tran_reversed	,PT.[prev_tran_approved]	PT_prev_tran_approved	,PT.[issuer_network_id]	PT_issuer_network_id	,PT.[acquirer_network_id]	PT_acquirer_network_id	,PT.[extended_tran_type]	PT_extended_tran_type	,PT.[from_account_type_qualifier]	PT_from_account_type_qualifier	,PT.[to_account_type_qualifier]	PT_to_account_type_qualifier	,PT.[bank_details]	PT_bank_details	,PT.[payee]	PT_payee	,PT.[card_verification_result]	PT_card_verification_result	,PT.[online_system_id]	PT_online_system_id	,PT.[participant_id]	PT_participant_id	,PT.[opp_participant_id]	PT_opp_participant_id	,PT.[receiving_inst_id_code]	PT_receiving_inst_id_code	,PT.[routing_type]	PT_routing_type	,PT.[pt_pos_operating_environment]	PT_pt_pos_operating_environment	,PT.[pt_pos_card_input_mode]	PT_pt_pos_card_input_mode	,PT.[pt_pos_cardholder_auth_method]	PT_pt_pos_cardholder_auth_method	,PT.[pt_pos_pin_capture_ability]	PT_pt_pos_pin_capture_ability	,PT.[pt_pos_terminal_operator]	PT_pt_pos_terminal_operator	,PT.[source_node_key]	PT_source_node_key	,PT.[proc_online_system_id]	PT_proc_online_system_id	,PTC.[post_tran_cust_id]	PTC_post_tran_cust_id	,PTC.[source_node_name]	PTC_source_node_name	,PTC.[draft_capture]	PTC_draft_capture	,PTC.[pan]	PTC_pan	,PTC.[card_seq_nr]	PTC_card_seq_nr	,PTC.[expiry_date]	PTC_expiry_date	,PTC.[service_restriction_code]	PTC_service_restriction_code	,PTC.[terminal_id]	PTC_terminal_id	,PTC.[terminal_owner]	PTC_terminal_owner	,PTC.[card_acceptor_id_code]	PTC_card_acceptor_id_code	,PTC.[mapped_card_acceptor_id_code]	PTC_mapped_card_acceptor_id_code	,PTC.[merchant_type]	PTC_merchant_type	,PTC.[card_acceptor_name_loc]	PTC_card_acceptor_name_loc	,PTC.[address_verification_data]	PTC_address_verification_data	,PTC.[address_verification_result]	PTC_address_verification_result	,PTC.[check_data]	PTC_check_data	,PTC.[totals_group]	PTC_totals_group	,PTC.[card_product]	PTC_card_product	,PTC.[pos_card_data_input_ability]	PTC_pos_card_data_input_ability	,PTC.[pos_cardholder_auth_ability]	PTC_pos_cardholder_auth_ability	,PTC.[pos_card_capture_ability]	PTC_pos_card_capture_ability	,PTC.[pos_operating_environment]	PTC_pos_operating_environment	,PTC.[pos_cardholder_present]	PTC_pos_cardholder_present	,PTC.[pos_card_present]	PTC_pos_card_present	,PTC.[pos_card_data_input_mode]	PTC_pos_card_data_input_mode	,PTC.[pos_cardholder_auth_method]	PTC_pos_cardholder_auth_method	,PTC.[pos_cardholder_auth_entity]	PTC_pos_cardholder_auth_entity	,PTC.[pos_card_data_output_ability]	PTC_pos_card_data_output_ability	,PTC.[pos_terminal_output_ability]	PTC_pos_terminal_output_ability	,PTC.[pos_pin_capture_ability]	PTC_pos_pin_capture_ability	,PTC.[pos_terminal_operator]	PTC_pos_terminal_operator	,PTC.[pos_terminal_type]	PTC_pos_terminal_type	,PTC.[pan_search]	PTC_pan_search	,PTC.[pan_encrypted]	PTC_pan_encrypted	,PTC.[pan_reference]	PTC_pan_reference
FROM  (select * from  postilion_office.dbo.post_tran AS t  WITH (NOLOCK, index(IX_POST_TRAN_9))
JOIN (SELECT  [DATE] recon_business_date_2 FROM  postilion_office.dbo.[get_dates_in_range](''SETTLE_START_DATE'', ''SETTLE_END_DATE'' ))rdate
ON (rdate.recon_business_date_2 = t.recon_business_date)
AND post_tran_id NOT IN (
					SELECT  post_tran_id  FROM postilion_office.dbo.tbl_late_reversals ll (NOLOCK) 
		WHERE ll.recon_business_date >= ''SETTLE_START_DATE''
		and (datepart(D,ll.rev_datetime_req) - datepart(D, ll.trans_datetime_req ))>1 
					) AND
					rsp_code_rsp IN (''00'',''11'',''09''))PT
 LEFT JOIN  postilion_office.dbo.Post_tran_cust AS PTC WITH  (NOLOCK)
ON (PT.post_tran_cust_id = PTC.post_tran_cust_id
 AND  LEFT( source_node_name,2 ) <> ''SB''
AND  CHARINDEX(''TPP'',source_node_name )<1
AND source_node_name <> ''SWTMEGADSsrc'' )
AND LEFT(card_acceptor_id_code,3) <>''IPG''
WHERE
 LEFT(sink_node_name,2)<> ''SB''
				 and  sink_node_name <> ''WUESBPBsnk''
	   and CHARINDEX(''TPP'', sink_node_name) < 1 OPTION(RECOMPILE,optimize for unknown ) ')


END
ELSE  BEGIN

 SELECT * FROM  OPENQUERY( [172.75.75.19], 
'SELECT PT.[post_tran_id]	PT_post_tran_id	,PT.[post_tran_cust_id]	PT_post_tran_cust_id	,PT.[settle_entity_id]	PT_settle_entity_id	,PT.[batch_nr]	PT_batch_nr	,PT.[prev_post_tran_id]	PT_prev_post_tran_id	,PT.[next_post_tran_id]	PT_next_post_tran_id	,PT.[sink_node_name]	PT_sink_node_name	,PT.[tran_postilion_originated]	PT_tran_postilion_originated	,PT.[tran_completed]	PT_tran_completed	,PT.[message_type]	PT_message_type	,PT.[tran_type]	PT_tran_type	,PT.[tran_nr]	PT_tran_nr	,PT.[system_trace_audit_nr]	PT_system_trace_audit_nr	,PT.[rsp_code_req]	PT_rsp_code_req	,PT.[rsp_code_rsp]	PT_rsp_code_rsp	,PT.[abort_rsp_code]	PT_abort_rsp_code	,PT.[auth_id_rsp]	PT_auth_id_rsp	,PT.[auth_type]	PT_auth_type	,PT.[auth_reason]	PT_auth_reason	,PT.[retention_data]	PT_retention_data	,PT.[acquiring_inst_id_code]	PT_acquiring_inst_id_code	,PT.[message_reason_code]	PT_message_reason_code	,PT.[sponsor_bank]	PT_sponsor_bank	,PT.[retrieval_reference_nr]	PT_retrieval_reference_nr	,PT.[datetime_tran_gmt]	PT_datetime_tran_gmt	,PT.[datetime_tran_local]	PT_datetime_tran_local	,PT.[datetime_req]	PT_datetime_req	,PT.[datetime_rsp]	PT_datetime_rsp	,PT.[realtime_business_date]	PT_realtime_business_date	,PT.[recon_business_date]	PT_recon_business_date	,PT.[from_account_type]	PT_from_account_type	,PT.[to_account_type]	PT_to_account_type	,PT.[from_account_id]	PT_from_account_id	,PT.[to_account_id]	PT_to_account_id	,PT.[tran_amount_req]	PT_tran_amount_req	,PT.[tran_amount_rsp]	PT_tran_amount_rsp	,PT.[settle_amount_impact]	PT_settle_amount_impact	,PT.[tran_cash_req]	PT_tran_cash_req	,PT.[tran_cash_rsp]	PT_tran_cash_rsp	,PT.[tran_currency_code]	PT_tran_currency_code	,PT.[tran_tran_fee_req]	PT_tran_tran_fee_req	,PT.[tran_tran_fee_rsp]	PT_tran_tran_fee_rsp	,PT.[tran_tran_fee_currency_code]	PT_tran_tran_fee_currency_code	,PT.[tran_proc_fee_req]	PT_tran_proc_fee_req	,PT.[tran_proc_fee_rsp]	PT_tran_proc_fee_rsp	,PT.[tran_proc_fee_currency_code]	PT_tran_proc_fee_currency_code	,PT.[settle_amount_req]	PT_settle_amount_req	,PT.[settle_amount_rsp]	PT_settle_amount_rsp	,PT.[settle_cash_req]	PT_settle_cash_req	,PT.[settle_cash_rsp]	PT_settle_cash_rsp	,PT.[settle_tran_fee_req]	PT_settle_tran_fee_req	,PT.[settle_tran_fee_rsp]	PT_settle_tran_fee_rsp	,PT.[settle_proc_fee_req]	PT_settle_proc_fee_req	,PT.[settle_proc_fee_rsp]	PT_settle_proc_fee_rsp	,PT.[settle_currency_code]	PT_settle_currency_code	,PT.[pos_entry_mode]	PT_pos_entry_mode	,PT.[pos_condition_code]	PT_pos_condition_code	,PT.[additional_rsp_data]	PT_additional_rsp_data	,PT.[tran_reversed]	PT_tran_reversed	,PT.[prev_tran_approved]	PT_prev_tran_approved	,PT.[issuer_network_id]	PT_issuer_network_id	,PT.[acquirer_network_id]	PT_acquirer_network_id	,PT.[extended_tran_type]	PT_extended_tran_type	,PT.[from_account_type_qualifier]	PT_from_account_type_qualifier	,PT.[to_account_type_qualifier]	PT_to_account_type_qualifier	,PT.[bank_details]	PT_bank_details	,PT.[payee]	PT_payee	,PT.[card_verification_result]	PT_card_verification_result	,PT.[online_system_id]	PT_online_system_id	,PT.[participant_id]	PT_participant_id	,PT.[opp_participant_id]	PT_opp_participant_id	,PT.[receiving_inst_id_code]	PT_receiving_inst_id_code	,PT.[routing_type]	PT_routing_type	,PT.[pt_pos_operating_environment]	PT_pt_pos_operating_environment	,PT.[pt_pos_card_input_mode]	PT_pt_pos_card_input_mode	,PT.[pt_pos_cardholder_auth_method]	PT_pt_pos_cardholder_auth_method	,PT.[pt_pos_pin_capture_ability]	PT_pt_pos_pin_capture_ability	,PT.[pt_pos_terminal_operator]	PT_pt_pos_terminal_operator	,PT.[source_node_key]	PT_source_node_key	,PT.[proc_online_system_id]	PT_proc_online_system_id	,PTC.[post_tran_cust_id]	PTC_post_tran_cust_id	,PTC.[source_node_name]	PTC_source_node_name	,PTC.[draft_capture]	PTC_draft_capture	,PTC.[pan]	PTC_pan	,PTC.[card_seq_nr]	PTC_card_seq_nr	,PTC.[expiry_date]	PTC_expiry_date	,PTC.[service_restriction_code]	PTC_service_restriction_code	,PTC.[terminal_id]	PTC_terminal_id	,PTC.[terminal_owner]	PTC_terminal_owner	,PTC.[card_acceptor_id_code]	PTC_card_acceptor_id_code	,PTC.[mapped_card_acceptor_id_code]	PTC_mapped_card_acceptor_id_code	,PTC.[merchant_type]	PTC_merchant_type	,PTC.[card_acceptor_name_loc]	PTC_card_acceptor_name_loc	,PTC.[address_verification_data]	PTC_address_verification_data	,PTC.[address_verification_result]	PTC_address_verification_result	,PTC.[check_data]	PTC_check_data	,PTC.[totals_group]	PTC_totals_group	,PTC.[card_product]	PTC_card_product	,PTC.[pos_card_data_input_ability]	PTC_pos_card_data_input_ability	,PTC.[pos_cardholder_auth_ability]	PTC_pos_cardholder_auth_ability	,PTC.[pos_card_capture_ability]	PTC_pos_card_capture_ability	,PTC.[pos_operating_environment]	PTC_pos_operating_environment	,PTC.[pos_cardholder_present]	PTC_pos_cardholder_present	,PTC.[pos_card_present]	PTC_pos_card_present	,PTC.[pos_card_data_input_mode]	PTC_pos_card_data_input_mode	,PTC.[pos_cardholder_auth_method]	PTC_pos_cardholder_auth_method	,PTC.[pos_cardholder_auth_entity]	PTC_pos_cardholder_auth_entity	,PTC.[pos_card_data_output_ability]	PTC_pos_card_data_output_ability	,PTC.[pos_terminal_output_ability]	PTC_pos_terminal_output_ability	,PTC.[pos_pin_capture_ability]	PTC_pos_pin_capture_ability	,PTC.[pos_terminal_operator]	PTC_pos_terminal_operator	,PTC.[pos_terminal_type]	PTC_pos_terminal_type	,PTC.[pan_search]	PTC_pan_search	,PTC.[pan_encrypted]	PTC_pan_encrypted	,PTC.[pan_reference]	PTC_pan_reference
FROM  (select * from  postilion_office.dbo.post_tran AS t  WITH (NOLOCK, index(IX_POST_TRAN_9))
JOIN (SELECT  [DATE] recon_business_date_2 FROM  postilion_office.dbo.[get_dates_in_range](''SETTLE_START_DATE'', ''SETTLE_END_DATE'' ))rdate
ON (rdate.recon_business_date_2 = t.recon_business_date)
AND post_tran_id NOT IN (
					SELECT  post_tran_id  FROM postilion_office.dbo.tbl_late_reversals ll (NOLOCK) 
		WHERE ll.recon_business_date >= ''SETTLE_START_DATE''
		and (datepart(D,ll.rev_datetime_req) - datepart(D, ll.trans_datetime_req ))>1 
					) AND
					rsp_code_rsp IN (''00'',''11'',''09''))PT
 LEFT JOIN  postilion_office.dbo.Post_tran_cust AS PTC WITH  (NOLOCK)
ON (PT.post_tran_cust_id = PTC.post_tran_cust_id
 AND  LEFT( source_node_name,2 ) <> ''SB''
AND  CHARINDEX(''TPP'',source_node_name )<1
AND source_node_name <> ''SWTMEGADSsrc'' )
AND LEFT(card_acceptor_id_code,3) <>''IPG''
WHERE
 LEFT(sink_node_name,2)<> ''SB''
				 and  sink_node_name <> ''WUESBPBsnk''
	   and CHARINDEX(''TPP'', sink_node_name) < 1 OPTION(RECOMPILE,optimize for unknown ) ')



END


END